<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Cart - Tiles Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        /* --- Global Background Animations --- */
        body {
            background: linear-gradient(270deg, #0d0320, #1a094b, #000000, #8e2de2, #000000);
            background-size: 300% 300%;
            animation: gradientBG 20s ease infinite;
            padding-top: 5rem; /* Adjust to match header height, prevents content from hiding under fixed header */
        }
        @media (min-width: 640px) { /* sm breakpoint */
           body {
             padding-top: 5.5rem; /* Slightly more for sm header if p-4 is used */
           }
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .stars-container {
            position: fixed; 
            top: 0; left: 0; width: 100vw; height: 100vh;
            pointer-events: none; overflow: hidden; z-index: -1; 
        }
        .star {
            position: absolute; background-color: rgba(255, 255, 255, 0.7);
            border-radius: 50%; animation: twinkle 6s infinite ease-in-out;
        }
        .star:nth-child(5n+1) { animation-delay: 0s; }
        .star:nth-child(5n+2) { animation-delay: -1.2s; }
        .star:nth-child(5n+3) { animation-delay: -2.4s; }
        .star:nth-child(5n+4) { animation-delay: -3.6s; }
        .star:nth-child(5n+5) { animation-delay: -4.8s; }
        @keyframes twinkle {
            0%, 100% { opacity: 0.1; transform: scale(0.6); }
            50% { opacity: 0.7; transform: scale(1); }
        }

        /* General Navbar */
        .navbar.translate-x-0 { transform: translateX(0%); }
        .navbar.-translate-x-full { transform: translateX(-100%); }
        
        /* Checkout Modal Styles */
        #checkout-modal.opacity-0 { opacity: 0; }
        #checkout-modal:not(.opacity-0) { opacity: 1; } 

        #checkout-modal .bg-gray-800.scale-95 { transform: scale(0.95); }
        #checkout-modal:not(.opacity-0) .bg-gray-800 { transform: scale(1); }

        .stepper .step.active .step-circle {
            background-color: #6366f1; /* indigo-500 */
            color: white;
        }
        .stepper .step.active {
            color: #c7d2fe; /* indigo-200 */
            font-weight: 600;
        }
        .stepper .step-line {
            transition: border-color 0.3s ease;
        }
        .stepper .step.completed .step-circle {
            background-color: #10b981; /* green-500 */
            color: white;
        }
        .stepper .step.completed ~ .step-line,
        .stepper .step.active ~ .step-line { 
            /* border-color: #6366f1; */ /* Optional: change line color */
        }
    </style>
</head>
<body class="text-gray-200 font-poppins">

    <!-- Animated Star Background - Global -->
    <div class="stars-container fixed inset-0 z-[-1] pointer-events-none" id="stars-bg-global">
        <!-- Stars will be injected here by JavaScript -->
    </div>
    <!-- Header -->
    <header id="main-header" class="fixed w-full top-0 left-0 bg-gray-900/80 backdrop-blur-md shadow-2xl flex items-center justify-between p-3 sm:p-4 z-40 border-b border-cyan-500/30">
        <div class="flex-none">
            <button id="toggle-btn-cart" aria-label="Toggle menu" aria-expanded="false" aria-controls="main-navbar-cart" class="text-xl sm:text-2xl text-cyan-400 hover:text-cyan-300 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-cyan-300 rounded">☰</button>
        </div>
        <div class="flex-grow text-center px-2">
            <a href="index.html" class="text-base sm:text-lg md:text-xl lg:text-2xl font-bold text-cyan-400 truncate hover:text-cyan-300">SAI BALAJI TILES HOME</a>
        </div>
        <div class="flex-none w-6 sm:w-8 h-6 sm:h-8"></div>
    </header>

    <!-- Navigation -->
    <nav id="main-navbar-cart" class="navbar fixed top-0 left-0 w-64 sm:w-72 h-screen bg-gray-900/80 backdrop-blur-md shadow-lg transform -translate-x-full transition-transform duration-300 z-30 border-r border-cyan-500/30" role="navigation" aria-label="Main navigation">
        <!-- Nav padding-top accounts for fixed header height -->
        <ul class="nav-menu mt-16 sm:mt-20 space-y-3 sm:space-y-4 p-4 pt-[calc(5rem+1rem)] sm:pt-[calc(5.5rem+1rem)]"> 
            <li><a href="index.html#home" class="block py-2 px-2 text-indigo-300 hover:text-indigo-200 hover:bg-gray-800/60 rounded transition-colors duration-300 text-sm sm:text-base">Home</a></li>
            <li><a href="index.html#catalog" class="block py-2 px-2 text-indigo-300 hover:text-indigo-200 hover:bg-gray-800/60 rounded transition-colors duration-300 text-sm sm:text-base">Catalog</a></li>
            <li><a href="index.html#about" class="block py-2 px-2 text-indigo-300 hover:text-indigo-200 hover:bg-gray-800/60 rounded transition-colors duration-300 text-sm sm:text-base">About Us</a></li>
            <li><a href="index.html#collections" class="block py-2 px-2 text-indigo-300 hover:text-indigo-200 hover:bg-gray-800/60 rounded transition-colors duration-300 text-sm sm:text-base">Collections</a></li>
            <li><a href="index.html#contact" class="block py-2 px-2 text-indigo-300 hover:text-indigo-200 hover:bg-gray-800/60 rounded transition-colors duration-300 text-sm sm:text-base">Contact</a></li>
            <li><a href="cart.html" class="block py-2 px-2 text-indigo-300 hover:text-indigo-200 hover:bg-gray-800/60 rounded transition-colors duration-300 text-sm sm:text-base">Cart (<span id="cart-count-cart">0</span>)</a></li>
        </ul>
    </nav>

    <!-- Cart Section -->
    <main> <!-- Wrap main content in <main> for semantic HTML and padding adjustment -->
        <section class="cart py-12 sm:py-16 bg-transparent min-h-[calc(100vh-5rem)] sm:min-h-[calc(100vh-5.5rem)]"> <!-- Adjusted padding and min-height -->
            <div class="container mx-auto px-4 text-center">
                <h2 class="text-2xl sm:text-3xl md:text-4xl font-bold mb-8 text-cyan-400">Your Shopping Cart</h2>
                <div id="cart-items-container" class="space-y-4 sm:space-y-6 mb-8 sm:mb-10 max-w-xl md:max-w-2xl mx-auto">
                    <!-- Cart items will be populated by JavaScript -->
                </div>
                <div id="cart-empty-message" class="hidden text-lg sm:text-xl text-indigo-300 mb-8">
                    Your cart is currently empty. <a href="index.html#catalog" class="font-semibold hover:text-cyan-400 underline">Browse our catalog!</a>
                </div>
                <button id="checkout-btn" 
                    class="bg-indigo-500 text-white px-6 py-3 sm:px-8 rounded-lg shadow-lg 
                                   text-base sm:text-lg font-semibold w-full sm:w-auto
                                   transition-all duration-300 ease-in-out 
                                   transform hover:bg-indigo-600 hover:shadow-xl hover:-translate-y-1 hover:scale-105 
                                   focus:outline-none focus:ring-4 focus:ring-indigo-300 focus:ring-opacity-75 
                                   active:bg-indigo-700 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span class="button-text">Proceed to Checkout</span>
                    <!-- Loader span removed from here as it's not used in the new flow -->
                </button>
                <div id="checkout-status" class="mt-4 text-sm sm:text-base"></div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 text-gray-400 text-center py-6 border-t border-cyan-500/30">
        <p class="text-sm sm:text-base">© 2025 Sai Balaji Tiles Home. All Rights Reserved.</p>
    </footer>

    <!-- Checkout Modal -->
    <div id="checkout-modal" class="fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden opacity-0 transition-opacity duration-300 ease-in-out" role="dialog" aria-modal="true" aria-labelledby="checkout-modal-title">
        <div class="bg-gray-800 w-full max-w-2xl rounded-xl shadow-2xl transform scale-95 transition-transform duration-300 ease-in-out overflow-y-auto max-h-[90vh]">
            <div class="p-6 sm:p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="checkout-modal-title" class="text-2xl sm:text-3xl font-bold text-cyan-400">Checkout Process</h2>
                    <button id="close-checkout-modal-btn" aria-label="Close checkout" class="text-gray-400 hover:text-gray-200 text-3xl">×</button>
                </div>

                <div class="stepper flex justify-between mb-8 text-xs sm:text-sm">
                    <div id="step-1-indicator" class="step active flex-1 text-center">
                        <span class="step-circle bg-indigo-500 text-white rounded-full w-6 h-6 sm:w-8 sm:h-8 flex items-center justify-center mx-auto mb-1">1</span>
                        Review Cart
                    </div>
                    <div class="step-line flex-1 border-t-2 border-gray-600 mt-3 sm:mt-4"></div>
                    <div id="step-2-indicator" class="step flex-1 text-center text-gray-500">
                        <span class="step-circle bg-gray-600 text-gray-300 rounded-full w-6 h-6 sm:w-8 sm:h-8 flex items-center justify-center mx-auto mb-1">2</span>
                        Your Details
                    </div>
                    <div class="step-line flex-1 border-t-2 border-gray-600 mt-3 sm:mt-4"></div>
                    <div id="step-3-indicator" class="step flex-1 text-center text-gray-500">
                        <span class="step-circle bg-gray-600 text-gray-300 rounded-full w-6 h-6 sm:w-8 sm:h-8 flex items-center justify-center mx-auto mb-1">3</span>
                        Measurements
                    </div>
                </div>

                <form id="checkoutForm">
                    <div id="checkout-step-1" class="checkout-step">
                        <h3 class="text-xl font-semibold text-indigo-300 mb-4">Step 1: Review Your Cart</h3>
                        <div id="modal-cart-items-summary" class="space-y-3 mb-6 max-h-60 overflow-y-auto p-1 border border-gray-700 rounded-md">
                        </div>
                        <div class="text-right">
                            <button type="button" id="next-to-step-2" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">Next: Your Details →</button>
                        </div>
                    </div>

                    <div id="checkout-step-2" class="checkout-step hidden">
                        <h3 class="text-xl font-semibold text-indigo-300 mb-4">Step 2: Your Details</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="customerName" class="block text-sm font-medium text-gray-300 mb-1">Full Name <span class="text-red-500">*</span></label>
                                <input type="text" id="customerName" name="customerName" required class="w-full p-2.5 bg-gray-700/60 border border-gray-600 rounded-md text-gray-200 focus:ring-2 focus:ring-cyan-400 outline-none">
                            </div>
                            <div>
                                <label for="customerPhone" class="block text-sm font-medium text-gray-300 mb-1">Phone Number <span class="text-red-500">*</span></label>
                                <input type="tel" id="customerPhone" name="customerPhone" required class="w-full p-2.5 bg-gray-700/60 border border-gray-600 rounded-md text-gray-200 focus:ring-2 focus:ring-cyan-400 outline-none">
                            </div>
                            <div>
                                <label for="customerAddress" class="block text-sm font-medium text-gray-300 mb-1">Delivery Address <span class="text-red-500">*</span></label>
                                <textarea id="customerAddress" name="customerAddress" rows="3" required class="w-full p-2.5 bg-gray-700/60 border border-gray-600 rounded-md text-gray-200 focus:ring-2 focus:ring-cyan-400 outline-none resize-none"></textarea>
                            </div>
                            <div>
                                <label for="customerMessage" class="block text-sm font-medium text-gray-300 mb-1">Additional Message (Optional)</label>
                                <textarea id="customerMessage" name="customerMessage" rows="3" class="w-full p-2.5 bg-gray-700/60 border border-gray-600 rounded-md text-gray-200 focus:ring-2 focus:ring-cyan-400 outline-none resize-none"></textarea>
                            </div>
                        </div>
                        <div class="flex justify-between mt-8">
                            <button type="button" id="back-to-step-1" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">← Back</button>
                            <button type="button" id="next-to-step-3" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">Next: Measurements →</button>
                        </div>
                    </div>

                    <div id="checkout-step-3" class="checkout-step hidden">
                        <h3 class="text-xl font-semibold text-indigo-300 mb-4">Step 3: Upload Measurement Photo</h3>
                        <p class="text-gray-400 text-sm mb-4">
                            Please upload a clear photo of your space or a sketch with measurements. This helps us provide a more accurate quote.
                        </p>
                        <div>
                            <label for="measurementPhoto" class="block text-sm font-medium text-gray-300 mb-1">Measurement Photo <span class="text-red-500">*</span></label>
                            <input type="file" id="measurementPhoto" name="measurementPhoto" accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-500 file:text-white hover:file:bg-indigo-600 cursor-pointer">
                            <img id="photoPreview" src="#" alt="Photo Preview" class="hidden mt-3 max-h-40 rounded-md border border-gray-600"/>
                            <p id="fileUploadInfo" class="text-xs text-gray-500 mt-1">Max file size: 5MB. Accepted: JPG, PNG, GIF.</p>
                            
                            <p class="text-amber-400 text-xs mt-3">
                                <strong>Note:</strong> If issues with direct upload, use a service like
                                <a href="https://imgbb.com/" target="_blank" rel="noopener noreferrer" class="underline hover:text-amber-300">imgbb.com</a>
                                and paste the link below.
                            </p>
                            <label for="measurementPhotoLink" class="block text-sm font-medium text-gray-300 mt-2 mb-1">Or, paste photo link here:</label>
                            <input type="url" id="measurementPhotoLink" name="measurementPhotoLink" placeholder="https://example.com/your-photo.jpg" class="w-full p-2.5 bg-gray-700/60 border border-gray-600 rounded-md text-gray-200 focus:ring-2 focus:ring-cyan-400 outline-none">
                        </div>
                        <input type="hidden" name="cartItemsData" id="cartItemsDataField">
                        <div class="flex justify-between mt-8">
                            <button type="button" id="back-to-step-2" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">← Back</button>
                            <button type="submit" id="submitOrderBtn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105">
                                <span class="button-text">Submit Order Inquiry</span>
                                <span class="button-loader hidden">Submitting...</span>
                            </button>
                        </div>
                    </div>
                </form>
                <div id="modal-form-status" class="mt-6 text-center text-sm"></div>
            </div>
        </div>
    </div>


    <!-- Scripts -->
    <script>
        // --- Star Generation (Global) ---
        function createStarsGlobal() {
            const container = document.getElementById('stars-bg-global');
            if (!container) return;
            container.innerHTML = ''; // Clear existing stars if any on re-init
            const numStars = Math.floor(window.innerWidth / 25); // Density
            for (let i = 0; i < numStars; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                const size = Math.random() * 2.5 + 0.5;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.animationDuration = `${Math.random() * 3 + 4}s`;
                container.appendChild(star);
            }
        }

        // --- Menu Toggle for Cart Page ---
        let menuCartVisible = false;
        const navbarCart = document.getElementById("main-navbar-cart");
        const toggleBtnCart = document.getElementById("toggle-btn-cart");

        function toggleMenuCart() {
            menuCartVisible = !menuCartVisible;
            if (navbarCart) {
                navbarCart.classList.toggle("translate-x-0", menuCartVisible);
                navbarCart.classList.toggle("-translate-x-full", !menuCartVisible);
            }
            if (toggleBtnCart) {
                 toggleBtnCart.classList.toggle("text-cyan-600", menuCartVisible);
                 toggleBtnCart.setAttribute('aria-expanded', menuCartVisible);
            }
        }
        if (toggleBtnCart) { // Ensure button exists before adding listener
            toggleBtnCart.addEventListener('click', toggleMenuCart);
        }
        document.addEventListener("click", (e) => {
             if (menuCartVisible && navbarCart && toggleBtnCart) {
                 if (!navbarCart.contains(e.target) && e.target !== toggleBtnCart && !toggleBtnCart.contains(e.target) ) {
                    toggleMenuCart();
                }
            }
        });
         document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && menuCartVisible) {
                toggleMenuCart();
            }
        });

        // --- Cart Management Logic ---
        const cartItemsContainer = document.getElementById("cart-items-container");
        const cartEmptyMessage = document.getElementById("cart-empty-message");
        const openCheckoutBtn = document.getElementById("checkout-btn"); // Renamed from checkoutButton
        const checkoutStatusEl = document.getElementById("checkout-status"); // Main page status

        function updateCartDisplay() {
            const cart = JSON.parse(localStorage.getItem("cart")) || [];
            if (cartItemsContainer) cartItemsContainer.innerHTML = ""; 
            if (cart.length === 0) {
                if (cartEmptyMessage) cartEmptyMessage.classList.remove("hidden");
                if (cartItemsContainer) cartItemsContainer.classList.add("hidden");
                if (openCheckoutBtn) openCheckoutBtn.disabled = true;
            } else {
                if (cartEmptyMessage) cartEmptyMessage.classList.add("hidden");
                if (cartItemsContainer) cartItemsContainer.classList.remove("hidden");
                if (openCheckoutBtn) openCheckoutBtn.disabled = false;
                cart.forEach((item, index) => {
                    const div = document.createElement("div");
                    div.className = "cart-item flex flex-col sm:flex-row items-center justify-between bg-gray-800/70 rounded-lg shadow-lg p-3 sm:p-4 transition-shadow duration-300 hover:shadow-xl gap-3 sm:gap-4 border border-gray-700 hover:border-cyan-500/50";
                    div.innerHTML = `
                        <img src="${item.image || 'images/placeholder.jpg'}" alt="${item.name || 'Tile image'}" class="w-20 h-20 sm:w-24 sm:h-24 object-cover rounded-md border-2 border-gray-600">
                        <span class="flex-1 text-base sm:text-lg text-indigo-300 text-center sm:text-left">${item.name || 'Unknown Tile'}</span>
                        <button class="remove-btn bg-red-600 text-white px-3 py-1.5 sm:px-4 sm:py-2 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-50 transition-all duration-300 ease-in-out transform hover:scale-105 text-xs sm:text-sm font-semibold" onclick="removeFromCart(${index})" aria-label="Remove ${item.name || 'tile'} from cart">Remove</button>
                    `;
                    if (cartItemsContainer) cartItemsContainer.appendChild(div);
                });
            }
            updateCartCountCart();
        }

        function removeFromCart(index) {
            let cart = JSON.parse(localStorage.getItem("cart")) || [];
            cart.splice(index, 1);
            localStorage.setItem("cart", JSON.stringify(cart));
            updateCartDisplay(); // Update main cart
            populateCartSummaryInModal(); // Also update modal cart summary if open
        }

        function updateCartCountCart() {
            const cart = JSON.parse(localStorage.getItem("cart")) || [];
            const cartCountSpan = document.getElementById("cart-count-cart");
            if (cartCountSpan) cartCountSpan.textContent = cart.length;
            // Also update other cart counts if they exist (e.g., on index page)
            const cartCountIndex = document.getElementById("cart-count-index");
            if(cartCountIndex) cartCountIndex.textContent = cart.length;
            const cartCountDetail = document.getElementById("cart-count-detail");
            if(cartCountDetail) cartCountDetail.textContent = cart.length;
        }
        
        // --- Checkout Modal and Multi-Step Form Logic ---
        const checkoutModal = document.getElementById('checkout-modal');
        const closeCheckoutModalBtn = document.getElementById('close-checkout-modal-btn');
        const checkoutForm = document.getElementById('checkoutForm');
        const modalFormStatusEl = document.getElementById('modal-form-status');
        const submitOrderBtn = document.getElementById('submitOrderBtn');

        const steps = ['checkout-step-1', 'checkout-step-2', 'checkout-step-3'];
        const stepIndicators = ['step-1-indicator', 'step-2-indicator', 'step-3-indicator'];
        let currentStep = 0;

        function updateStepperUI() {
            stepIndicators.forEach((indicatorId, index) => {
                const indicator = document.getElementById(indicatorId);
                if (!indicator) return;
                const circle = indicator.querySelector('.step-circle');
                if (!circle) return;

                indicator.classList.remove('active', 'completed', 'text-gray-500', 'text-indigo-200', 'text-green-400');
                circle.classList.remove('bg-gray-600', 'bg-indigo-500', 'bg-green-500');
                
                if (index < currentStep) {
                    indicator.classList.add('completed', 'text-green-400');
                    circle.classList.add('bg-green-500');
                    circle.innerHTML = '✓';
                } else if (index === currentStep) {
                    indicator.classList.add('active', 'text-indigo-200');
                    circle.classList.add('bg-indigo-500');
                    circle.textContent = index + 1;
                } else {
                    indicator.classList.add('text-gray-500');
                    circle.classList.add('bg-gray-600');
                    circle.textContent = index + 1;
                }
            });
        }

        function showStep(stepIndex) {
            steps.forEach((stepId, index) => {
                const stepElement = document.getElementById(stepId);
                if (stepElement) stepElement.classList.toggle('hidden', index !== stepIndex);
            });
            currentStep = stepIndex;
            updateStepperUI();
        }

        function populateCartSummaryInModal() {
            const cart = JSON.parse(localStorage.getItem("cart")) || [];
            const summaryContainer = document.getElementById('modal-cart-items-summary');
            if (!summaryContainer) return;
            summaryContainer.innerHTML = ''; 

            if (cart.length === 0) {
                summaryContainer.innerHTML = '<p class="text-gray-400 p-2">Your cart is empty.</p>';
                document.getElementById('next-to-step-2').disabled = true; // Disable next if cart empty
                return;
            }
            document.getElementById('next-to-step-2').disabled = false;


            cart.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-center justify-between text-sm p-2 bg-gray-700/50 rounded';
                itemDiv.innerHTML = `
                    <img src="${item.image || 'images/placeholder.jpg'}" alt="${item.name}" class="w-10 h-10 object-cover rounded mr-3">
                    <span class="flex-grow text-gray-300 truncate">${item.name}</span>
                `;
                summaryContainer.appendChild(itemDiv);
            });
        }

        function openCheckoutModal() {
            if (checkoutModal) {
                const cart = JSON.parse(localStorage.getItem("cart")) || [];
                if (cart.length === 0) {
                    if(checkoutStatusEl) {
                        checkoutStatusEl.textContent = 'Your cart is empty. Please add items to proceed.';
                        checkoutStatusEl.className = 'mt-4 text-sm sm:text-base text-red-400';
                        setTimeout(() => {if(checkoutStatusEl) checkoutStatusEl.textContent = '';}, 3000);
                    }
                    return; 
                }
                populateCartSummaryInModal();
                showStep(0);
                checkoutModal.classList.remove('hidden');
                setTimeout(() => {
                    checkoutModal.classList.remove('opacity-0');
                    const modalContent = checkoutModal.querySelector('.bg-gray-800');
                    if (modalContent) modalContent.classList.remove('scale-95');
                }, 10);
                if(closeCheckoutModalBtn) closeCheckoutModalBtn.focus();
            }
        }

        function closeCheckoutModal() {
            if (checkoutModal) {
                checkoutModal.classList.add('opacity-0');
                const modalContent = checkoutModal.querySelector('.bg-gray-800');
                if (modalContent) modalContent.classList.add('scale-95');
                
                setTimeout(() => {
                    checkoutModal.classList.add('hidden');
                    if (checkoutForm) checkoutForm.reset();
                    if (modalFormStatusEl) {
                        modalFormStatusEl.textContent = '';
                        modalFormStatusEl.className = 'mt-6 text-center text-sm';
                    }
                    const photoPreviewEl = document.getElementById('photoPreview');
                    if(photoPreviewEl) {
                        photoPreviewEl.classList.add('hidden');
                        photoPreviewEl.src = "#"; // Clear preview src
                    }
                    const measurementPhotoInputEl = document.getElementById('measurementPhoto');
                    if(measurementPhotoInputEl) measurementPhotoInputEl.value = ""; // Clear file input
                }, 300);
                 if(openCheckoutBtn) openCheckoutBtn.focus();
            }
        }

        if (openCheckoutBtn) {
            openCheckoutBtn.addEventListener('click', openCheckoutModal);
        }
        if (closeCheckoutModalBtn) {
            closeCheckoutModalBtn.addEventListener('click', closeCheckoutModal);
        }
        if (checkoutModal) {
            checkoutModal.addEventListener('click', (event) => {
                if (event.target === checkoutModal) closeCheckoutModal();
            });
        }
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && checkoutModal && !checkoutModal.classList.contains('hidden')) {
                closeCheckoutModal();
            }
        });

        // Navigation buttons event listeners
        const nextToStep2Btn = document.getElementById('next-to-step-2');
        if(nextToStep2Btn) nextToStep2Btn.addEventListener('click', () => showStep(1));
        
        const backToStep1Btn = document.getElementById('back-to-step-1');
        if(backToStep1Btn) backToStep1Btn.addEventListener('click', () => showStep(0));

        const nextToStep3Btn = document.getElementById('next-to-step-3');
        if(nextToStep3Btn) {
            nextToStep3Btn.addEventListener('click', () => {
                const customerNameInput = document.getElementById('customerName');
                const customerPhoneInput = document.getElementById('customerPhone');
                const customerAddressInput = document.getElementById('customerAddress');
                let isValid = true;
                if (!customerNameInput.checkValidity()) { customerNameInput.reportValidity(); isValid = false; }
                if (isValid && !customerPhoneInput.checkValidity()) { customerPhoneInput.reportValidity(); isValid = false; }
                if (isValid && !customerAddressInput.checkValidity()) { customerAddressInput.reportValidity(); isValid = false; }

                if (isValid) {
                    showStep(2);
                    if (modalFormStatusEl) modalFormStatusEl.textContent = '';
                } else {
                    if (modalFormStatusEl) {
                        modalFormStatusEl.textContent = 'Please fill in all required fields in "Your Details".';
                        modalFormStatusEl.className = 'mt-6 text-center text-sm text-red-400';
                    }
                }
            });
        }
        
        const backToStep2Btn = document.getElementById('back-to-step-2');
        if(backToStep2Btn) backToStep2Btn.addEventListener('click', () => showStep(1));

        const measurementPhotoInput = document.getElementById('measurementPhoto');
        const photoPreview = document.getElementById('photoPreview');
        if (measurementPhotoInput && photoPreview) {
            measurementPhotoInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        photoPreview.src = e.target.result;
                        photoPreview.classList.remove('hidden');
                    }
                    reader.readAsDataURL(file);
                } else {
                    photoPreview.classList.add('hidden');
                    photoPreview.src = "#";
                }
            });
        }

        if (checkoutForm) {
            checkoutForm.addEventListener('submit', function(event) {
                event.preventDefault();
                if (modalFormStatusEl) {
                    modalFormStatusEl.textContent = '';
                    modalFormStatusEl.className = 'mt-6 text-center text-sm';
                }

                const submitBtnText = submitOrderBtn.querySelector('.button-text');
                const submitBtnLoader = submitOrderBtn.querySelector('.button-loader');

                if (submitBtnLoader) submitBtnText.classList.add('hidden');
                if (submitBtnLoader) submitBtnLoader.classList.remove('hidden');
                submitOrderBtn.disabled = true;

                const formData = new FormData(checkoutForm);
                const cart = JSON.parse(localStorage.getItem("cart")) || [];
                formData.set("cartItemsData", JSON.stringify(cart.map(item => ({name: item.name, id: item.id}))));

                const photoFile = formData.get('measurementPhoto');
                const photoLink = formData.get('measurementPhotoLink');

                if ((!photoFile || photoFile.size === 0) && !photoLink) {
                    if (modalFormStatusEl) {
                        modalFormStatusEl.textContent = 'Please upload a measurement photo or provide a link.';
                        modalFormStatusEl.className = 'mt-6 text-center text-sm text-red-400';
                    }
                    if (submitBtnLoader) submitBtnText.classList.remove('hidden');
                    if (submitBtnLoader) submitBtnLoader.classList.add('hidden');
                    submitOrderBtn.disabled = false;
                    return;
                }
                
                // !!! IMPORTANT: Replace with your NEW Formspree endpoint for orders !!!
                const orderFormSpreeEndpoint = 'https://formspree.io/f/movwvnvq';

                fetch(orderFormSpreeEndpoint, {
                    method: 'POST',
                    body: formData,
                    headers: { 'Accept': 'application/json' }
                }).then(response => {
                    if (response.ok) {
                        if (modalFormStatusEl) {
                            modalFormStatusEl.textContent = 'Order inquiry submitted successfully! We will contact you soon.';
                            modalFormStatusEl.classList.add('text-green-400');
                        }
                        localStorage.removeItem("cart");
                        updateCartDisplay();
                        updateCartCountCart();
                        setTimeout(() => { closeCheckoutModal(); }, 3000);
                    } else {
                        response.json().then(data => {
                           if (modalFormStatusEl) {
                             modalFormStatusEl.textContent = data.errors ? data.errors.map(e => e.message).join(', ') : 'Submission failed. Please try again.';
                             modalFormStatusEl.classList.add('text-red-400');
                           }
                        }).catch(() => {
                            if (modalFormStatusEl) {
                                modalFormStatusEl.textContent = 'Submission failed due to a server error. Please try again.';
                                modalFormStatusEl.classList.add('text-red-400');
                            }
                        });
                    }
                }).catch(error => {
                    console.error("Order submission error:", error);
                    if (modalFormStatusEl) {
                        modalFormStatusEl.textContent = 'Network error. Please check your connection and try again.';
                        modalFormStatusEl.classList.add('text-red-400');
                    }
                }).finally(() => {
                    if (submitBtnLoader) submitBtnText.classList.remove('hidden');
                    if (submitBtnLoader) submitBtnLoader.classList.add('hidden');
                    submitOrderBtn.disabled = false;
                });
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            createStarsGlobal();
            updateCartDisplay();
            const headerHeight = document.getElementById('main-header')?.offsetHeight || 0;
            // Adjust padding for nav menu items if header height is dynamic
            const navMenu = document.querySelector('#main-navbar-cart .nav-menu');
            if (navMenu && headerHeight > 0) {
                 navMenu.style.paddingTop = `calc(${headerHeight}px + 1rem)`; // 1rem is existing top margin/padding
            }
        });
        // Listen for cart updates from other pages
        window.addEventListener('storage', (event) => {
            if (event.key === 'cart') {
                updateCartDisplay();
                updateCartCountCart();
                if (checkoutModal && !checkoutModal.classList.contains('hidden')) {
                    populateCartSummaryInModal(); // Update modal summary if open
                }
            }
        });

    </script>
</body>
</html>